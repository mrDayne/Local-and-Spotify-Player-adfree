<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Lokaler Player + Embed-Preview (kein Access Token nötig)</title>
<style>
:root { --bg:#0f1724; --card:#0b1220; --muted:#9aa4b2; --accent:#1db954; --glass: rgba(255,255,255,0.04);} 
[data-theme="light"]{ --bg:#f6f7fb; --card:#ffffff; --muted:#59637a; --accent:#1db954; --glass: rgba(0,0,0,0.04);} 
*{box-sizing:border-box}
body{font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:0; min-height:100vh; background:linear-gradient(180deg,var(--bg), #071020); color: #e6eef5;}
.container{max-width:1100px;margin:24px auto;padding:20px;}
/* Header uses CSS grid: left (brand), center (search), right (controls) */
.header{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:16px;padding:8px 0}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,#1db954 0%,#1ed760 100%);display:flex;align-items:center;justify-content:center;box-shadow:0 6px 18px rgba(0,0,0,0.25)}
.logo svg{width:24px;height:24px;fill:white}
h1{margin:0;font-size:20px}
.controls{display:flex;gap:8px;align-items:center;justify-self:end;flex-wrap:wrap}
.input{display:flex;gap:8px;align-items:center;background:var(--card);padding:8px;border-radius:12px;box-shadow:0 4px 14px rgba(2,6,23,0.6)}
.input input{border:0;background:transparent;color:inherit;padding:8px;min-width:220px;outline:none}
.btn{background:var(--accent);border:none;color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);padding:6px 10px}
.toggle{cursor:pointer;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04)}
.grid{margin-top:20px;display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03));border-radius:14px;padding:12px;box-shadow:0 6px 24px rgba(2,6,23,0.5);display:flex;flex-direction:column;gap:10px}
.card .meta{display:flex;justify-content:space-between;align-items:center;gap:8px}
.small{font-size:12px;color:var(--muted)}
.actions{display:flex;gap:8px;flex-wrap:wrap}
.icon-btn{background:transparent;border:1px solid rgba(255,255,255,0.03);padding:6px 8px;border-radius:10px;cursor:pointer;color:var(--muted)}
.audioBadge{font-size:11px;color:var(--muted);border:1px dashed rgba(255,255,255,0.08);padding:2px 6px;border-radius:8px}
.footer{margin-top:18px;font-size:12px;color:var(--muted);display:flex;gap:12px;flex-wrap:wrap;align-items:center}
kbd{background:rgba(0,0,0,0.25);padding:3px 6px;border-radius:6px;font-weight:700}
.empty{padding:40px;border-radius:12px;background:var(--glass);text-align:center;color:var(--muted)}
.search{justify-self:center;background:var(--card);padding:10px 14px;border-radius:999px;display:flex;gap:8px;align-items:center;min-width:360px;box-shadow:0 8px 30px rgba(2,6,23,0.6);max-width:100%}
.search input{border:0;background:transparent;color:inherit;outline:none;font-size:14px;width:100%}
/* Player bar */
#playerBar{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06));padding:10px 14px;border-radius:14px;box-shadow:0 10px 40px rgba(2,6,23,0.6);display:flex;align-items:center;gap:12px;min-width:360px;max-width:940px;border:1px solid rgba(255,255,255,0.03)}
.playerCover{width:56px;height:56px;border-radius:6px;background:#111;flex:0 0 56px;overflow:hidden;display:flex;align-items:center;justify-content:center}
.playerMeta{display:flex;flex-direction:column;min-width:180px}
.playerTitle{font-weight:700}
.playerArtist{font-size:12px;color:var(--muted)}
.playerControls{display:flex;align-items:center;gap:8px}
.ctrl{background:transparent;border:0;color:var(--muted);cursor:pointer;padding:8px;border-radius:8px}
.progress{height:6px;background:rgba(255,255,255,0.06);border-radius:999px;overflow:hidden;width:240px}
.progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#23e27a);width:0%}
.playerHidden{display:none}
@media (max-width:900px){
  .header{grid-template-columns:1fr;grid-template-rows:auto auto;gap:12px}
  .controls{justify-self:start}
  .search{justify-self:stretch;min-width:0}
}
@media (max-width:520px){.search{min-width:220px}.playerMeta{min-width:100px}.progress{width:120px}}
</style>
</head>
<body>
<div class="container" id="app" data-theme="dark">
<header class="header">
  <div class="brand">
    <div class="logo" aria-hidden="true">
      <svg viewBox="0 0 168 168" xmlns="http://www.w3.org/2000/svg"><path d="M84 12C47 12 18 41 18 78s29 66 66 66 66-29 66-66S121 12 84 12z"/></svg>
    </div>
    <div>
      <h1>Meine Musik-Seite — lokal steuerbar</h1>
      <div class="small">Höre und steuere nur die Songs, die <em>auf dieser Seite</em> sind — kein Access Token nötig.</div>
    </div>
  </div>

  <!-- zentraler Suchbereich (jetzt im Header grid, nicht absolut) -->
  <div class="search" role="search">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="11" cy="11" r="6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
    <input id="searchInput" placeholder="Suchen (Titel, Künstler, Datei, URL)...">
    <button class="btn ghost" id="clearSearch">X</button>
  </div>

  <div class="controls">
    <div class="input" title="Audio-URL hier einfügen (z. B. .mp3)">
      <input id="audioUrl" placeholder="Audio-URL (https://… .mp3) oder Spotify-Link (optional)">
      <button class="btn" id="addUrlBtn">Hinzufügen</button>
    </div>
    <input id="fileInput" type="file" accept="audio/*" multiple style="display:none">
    <button class="btn ghost" id="addFilesBtn">Dateien hinzufügen</button>
    <button class="btn ghost" id="clearBtn">Alle entfernen</button>
    <button class="toggle" id="themeBtn" title="Hell / Dunkel umschalten">Theme</button>
  </div>
</header>

<main>
  <div id="grid" class="grid" aria-live="polite">
    <div class="empty" id="emptyNote">Füge <strong>Audio-Dateien</strong> oder <strong>direkte Audio-URLs</strong> hinzu. Spotify-Links werden als Vorschau (Embed) angezeigt, können aber nicht voll ferngesteuert werden ohne Token.</div>
  </div>

  <div class="footer">
    <div class="small">Tipp: Zieh Dateien per Drag & Drop rein oder nutze direkte MP3/OGG-URLs für volle Kontrolle.</div>
    <div style="margin-left:auto" class="small">Keine Tokens nötig — alles lokal gesteuert.</div>
  </div>
</main>

<!-- Bottom player (HTML5) -->
<div id="playerBar" class="playerHidden" aria-hidden="true">
  <div class="playerCover" id="playerCover">
    <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor" style="opacity:0.6"><path d="M12 3a9 9 0 100 18 9 9 0 000-18zm-1 5l6 4-6 4V8z"/></svg>
  </div>
  <div class="playerMeta">
    <div class="playerTitle" id="playerTitle">—</div>
    <div class="playerArtist" id="playerArtist">Lokale Datei/URL</div>
  </div>
  <div class="playerControls">
    <button class="ctrl" id="prevBtn" title="Vorheriger">⏮</button>
    <button class="ctrl" id="playBtn" title="Play/Pause">⏯</button>
    <button class="ctrl" id="nextBtn" title="Nächster">⏭</button>
  </div>
  <div class="progress" id="progress" title="Fortschritt"><i id="progressFill"></i></div>
  <div style="width:12px"></div>
  <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
    <div style="display:flex;gap:8px;align-items:center">
      <input id="autoplayToggle" type="checkbox" checked><label class="small" for="autoplayToggle">Auto</label>
    </div>
    <div class="small" id="playerStatus">Bereit</div>
  </div>
</div>

<!-- Embed preview area for services like Spotify (no control) -->
<div id="bottomEmbedWrap" style="display:none;position:fixed;left:50%;transform:translateX(-50%);bottom:86px;width:min(960px,calc(100% - 40px));z-index:60">
  <iframe id="bottomEmbed" width="100%" height="80" frameborder="0" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"></iframe>
</div>

</div>

<script>
/* -------------------- Data Model -------------------- */
const STORAGE_KEY = 'my_music_list_v1';
let sessionFiles = []; // object URLs for uploaded files (not persisted)

function loadPersisted(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY) || '[]';
    const list = JSON.parse(raw);
    if(!Array.isArray(list)) return [];
    // sanitize entries: only keep objects with required fields
    return list.filter(it => it && typeof it === 'object' && (it.type === 'audio' || it.type === 'embed') && typeof it.src === 'string');
  }catch(e){ console.warn('[loadPersisted] parse error', e); return []; }
}
function savePersisted(list){ localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); }
function getAll(){ return loadPersisted().concat(sessionFiles); }

/* -------------------- Helpers -------------------- */
function isValidHttpUrl(v){ try{ const u = new URL(v); return u.protocol === 'http:' || u.protocol === 'https:'; }catch(e){ return false; } }
function basename(path){ try{ if(!path) return '(Unbenannt)'; const u = new URL(path); return decodeURIComponent(u.pathname.split('/').filter(Boolean).pop() || path); }catch(e){ return (path && String(path).split('/').pop()) || '(Unbenannt)'; } }
function parseSpotifyUrl(input){ if(!input) return null; input = input.trim(); try{ const u = new URL(input); if(u.hostname && u.hostname.includes('spotify.com')){ const p = u.pathname.split('/').filter(Boolean); if(p.length>=2) return { platform:'spotify', type:p[0], id:p[1], src:'https://open.spotify.com/'+p[0]+'/'+p[1] }; } }catch(e){} return null; }
function embedSrcFor(item){ if(item.platform === 'spotify' || (item.src && item.src.includes('open.spotify.com'))) return 'https://open.spotify.com/embed/' + (item.type||'track') + '/' + (item.id||''); return item.src; }

/* -------------------- oEmbed metadata (optional) -------------------- */
async function fetchOembedForEmbed(item){
  try{
    const url = item.src;
    const r = await fetch('https://open.spotify.com/oembed?url=' + encodeURIComponent(url));
    if(!r.ok) return null;
    const data = await r.json();
    return { title: data.title, author: data.author_name, thumb: data.thumbnail_url };
  }catch(e){ return null; }
}

/* -------------------- Rendering -------------------- */
const emptyTemplate = document.getElementById('emptyNote');

function makeCard(item, index){
  if(!item || typeof item !== 'object') return document.createElement('div');
  const card = document.createElement('div'); card.className = 'card';
  const meta = document.createElement('div'); meta.className = 'meta';
  const left = document.createElement('div');
  const title = item.title || basename(item.src) || '(Unbenannt)';
  const subtitle = item.type === 'audio' ? (item.mime || 'Audio') : (item.type === 'embed' ? (item.platform ? item.platform.toUpperCase() : 'Embed') : 'Eintrag');
  left.innerHTML = '<div style="font-weight:700">'+title+'</div><div class="small">'+subtitle+'</div>';
  const actions = document.createElement('div'); actions.className = 'actions';

  // Play / Preview buttons
  if(item.type === 'audio'){
    const playBtn = document.createElement('button'); playBtn.className='icon-btn'; playBtn.textContent='Play'; playBtn.onclick = ()=> playIndex(index);
    actions.appendChild(playBtn);
  } else if(item.type === 'embed'){
    const previewBtn = document.createElement('button'); previewBtn.className='icon-btn'; previewBtn.textContent='Preview'; previewBtn.onclick = ()=> previewEmbed(item);
    actions.appendChild(previewBtn);
  }

  // reorder and delete
  const upBtn = document.createElement('button'); upBtn.className='icon-btn'; upBtn.textContent='▲'; upBtn.onclick=()=> moveItem(index,-1);
  const downBtn = document.createElement('button'); downBtn.className='icon-btn'; downBtn.textContent='▼'; downBtn.onclick=()=> moveItem(index,1);
  const delBtn = document.createElement('button'); delBtn.className='icon-btn'; delBtn.textContent='Löschen'; delBtn.onclick=()=> removeItem(item);
  actions.appendChild(upBtn); actions.appendChild(downBtn); actions.appendChild(delBtn);

  meta.appendChild(left); meta.appendChild(actions); card.appendChild(meta);

  // thumbnail if available
  if(item.thumb){ const img = document.createElement('img'); img.src = item.thumb; img.style.width='56px'; img.style.height='56px'; img.style.borderRadius='8px'; img.alt = title; img.style.objectFit='cover'; card.appendChild(img); }

  const badge = document.createElement('div'); badge.className='audioBadge'; badge.textContent = item.type === 'audio' ? (item.mime || 'Audio') : 'Embed: ' + (item.platform || 'extern');
  card.appendChild(badge);
  return card;
}

function render(filter){
  const grid = document.getElementById('grid'); if(!grid) return;
  grid.innerHTML = '';
  const list = getAll();
  const filtered = (Array.isArray(list) ? list : []).filter(i => {
    if(!filter) return true; const q = String(filter).toLowerCase(); const t = (i && i.title)?String(i.title).toLowerCase():''; const s = (i && i.src)?String(i.src).toLowerCase():''; return t.includes(q) || s.includes(q);
  });
  if(filtered.length === 0){
    const empty = emptyTemplate || (function(){ const d = document.createElement('div'); d.className='empty'; d.textContent='Keine Einträge.'; return d; })();
    grid.appendChild(empty.cloneNode(true));
    return;
  }
  filtered.forEach((item,idx)=>{
    try{
      const node = makeCard(item, idx);
      if(node && node.nodeType === 1) grid.appendChild(node);
      else console.warn('skip invalid card', item);
    }catch(err){ console.error('render makeCard error', err, item); }
  });
}

/* -------------------- Add / Remove / Reorder -------------------- */
async function addAudioUrl(url){
  if(!isValidHttpUrl(url)) return alert('Bitte eine gültige http(s)-Audio-URL eingeben');
  const low = url.toLowerCase(); const mime = low.endsWith('.mp3')? 'audio/mpeg' : low.endsWith('.ogg')? 'audio/ogg' : low.endsWith('.wav')? 'audio/wav' : '';
  const persisted = loadPersisted();
  persisted.push({type:'audio', src:url, title:basename(url), mime});
  savePersisted(persisted); render(document.getElementById('searchInput').value);
}

async function addSpotifyLink(url){
  const parsed = parseSpotifyUrl(url);
  if(!parsed) return alert('Kein gültiger Spotify-Link');
  const persisted = loadPersisted();
  const item = { type:'embed', platform: parsed.platform || 'spotify', src: parsed.src, id: parsed.id, title: null, thumb: null };
  const meta = await fetchOembedForEmbed(item).catch(()=>null);
  if(meta){ item.title = meta.title; item.thumb = meta.thumb || null; }
  persisted.push(item); savePersisted(persisted); render(document.getElementById('searchInput').value);
}

function addFiles(files){ const arr = Array.from(files||[]); arr.forEach(f => { try{ const src = URL.createObjectURL(f); sessionFiles.push({type:'audio', src, title:f.name, mime:f.type||'audio/*'}); }catch(e){console.error('addFiles err',e);} }); render(document.getElementById('searchInput').value); }

function removeItem(item){ if(!item) return; if(item.type === 'audio' && item.src && item.src.startsWith('blob:')){ sessionFiles = sessionFiles.filter(x=>x.src !== item.src); try{ URL.revokeObjectURL(item.src); }catch(e){} } else { const list = loadPersisted().filter(x=>x.src !== item.src); savePersisted(list); } render(document.getElementById('searchInput').value); }

function moveItem(index, dir){ const all = getAll(); const newIndex = index + dir; if(newIndex<0||newIndex>=all.length) return; const unified = all.slice(); const [moved] = unified.splice(index,1); unified.splice(newIndex,0,moved); const newPersisted = unified.filter(x=>x.type==='audio' && !x.src.startsWith('blob:') || x.type==='embed'); const newSession = unified.filter(x=>x.type==='audio' && x.src.startsWith('blob:')); savePersisted(newPersisted); sessionFiles = newSession; render(document.getElementById('searchInput').value); }

/* -------------------- Player -------------------- */
const audio = new Audio(); audio.preload='metadata';
let queue = []; let currentIndex = -1; let isPlaying = false; let duration = 0;
function rebuildQueue(){ queue = getAll().filter(x=>x && x.type === 'audio'); }
function showPlayer(){ const bar = document.getElementById('playerBar'); if(currentIndex<0 || currentIndex>=queue.length){ bar.classList.add('playerHidden'); return; } const cur = queue[currentIndex]||{}; bar.classList.remove('playerHidden'); document.getElementById('playerTitle').textContent = cur.title || basename(cur.src); document.getElementById('playerArtist').textContent = cur.mime || 'Audio'; document.getElementById('playerStatus').textContent = isPlaying ? 'Wiedergabe' : 'Pausiert'; }

function playIndex(index){ rebuildQueue(); if(index<0||index>=queue.length) return; currentIndex = index; const cur = queue[currentIndex]; if(!cur || !cur.src) return; audio.src = cur.src; audio.play().then(()=>{ isPlaying=true; showPlayer(); }).catch(err=>{ alert('Abspielen fehlgeschlagen: '+err.message); isPlaying=false; showPlayer(); }); }
function playNext(){ if(!queue.length) return; currentIndex = (currentIndex+1)%queue.length; playIndex(currentIndex); }
function playPrev(){ if(!queue.length) return; currentIndex = (currentIndex-1+queue.length)%queue.length; playIndex(currentIndex); }

audio.addEventListener('loadedmetadata', ()=>{ duration = audio.duration || 0; });
audio.addEventListener('timeupdate', ()=>{ const p = document.getElementById('progressFill'); if(!duration) duration = audio.duration||0; const pos = audio.currentTime||0; const pct = duration ? Math.min(100, Math.floor((pos/duration)*100)) : 0; if(p) p.style.width = pct + '%'; });
audio.addEventListener('ended', ()=>{ document.getElementById('playerStatus').textContent='Beendet'; if(document.getElementById('autoplayToggle').checked) playNext(); });
audio.addEventListener('play', ()=>{ isPlaying=true; showPlayer(); });
audio.addEventListener('pause', ()=>{ isPlaying=false; showPlayer(); });

// progress seek
const progressBar = document.getElementById('progress'); if(progressBar){ progressBar.addEventListener('click', (e)=>{ const rect = progressBar.getBoundingClientRect(); const x = e.clientX - rect.left; const pct = x/rect.width; if(duration) audio.currentTime = duration * pct; }); }

/* -------------------- Embed preview (no control) -------------------- */
function previewEmbed(item){ if(!item || !item.src) return; const bottomWrap = document.getElementById('bottomEmbedWrap'); const bottom = document.getElementById('bottomEmbed'); let src = item.src; try{ const u = new URL(item.src); if(u.hostname.includes('spotify.com')){ const parts = u.pathname.split('/').filter(Boolean); if(parts.length>=2) src = 'https://open.spotify.com/embed/' + parts[0] + '/' + parts[1]; } }catch(e){} bottom.src = src; bottomWrap.style.display = 'block'; }

/* -------------------- UI wiring -------------------- */
document.getElementById('addUrlBtn').addEventListener('click', async ()=>{ const val = document.getElementById('audioUrl').value.trim(); if(!val) return; if(val.includes('open.spotify.com')){ await addSpotifyLink(val); } else { await addAudioUrl(val); } document.getElementById('audioUrl').value=''; });
document.getElementById('addFilesBtn').addEventListener('click', ()=> document.getElementById('fileInput').click());
document.getElementById('fileInput').addEventListener('change', (e)=> addFiles(e.target.files));
// drag & drop
window.addEventListener('dragover', (e)=>{ e.preventDefault(); });
window.addEventListener('drop', (e)=>{ e.preventDefault(); if(e.dataTransfer?.files?.length) addFiles(e.dataTransfer.files); });

document.getElementById('clearBtn').addEventListener('click', ()=>{ if(confirm('Alle Einträge löschen? (Dateien der aktuellen Sitzung werden vergessen)')){ localStorage.removeItem(STORAGE_KEY); sessionFiles.forEach(f=>{ try{ URL.revokeObjectURL(f.src);}catch(e){} }); sessionFiles=[]; render(); } });

document.getElementById('themeBtn').addEventListener('click', ()=>{ const app = document.getElementById('app'); const current = app.getAttribute('data-theme')||'dark'; app.setAttribute('data-theme', current==='dark'?'light':'dark'); });

document.getElementById('searchInput').addEventListener('input', (e)=> render(e.target.value));
document.getElementById('clearSearch').addEventListener('click', ()=>{ document.getElementById('searchInput').value=''; render(''); });

document.getElementById('nextBtn').addEventListener('click', ()=> playNext());
document.getElementById('prevBtn').addEventListener('click', ()=> playPrev());
document.getElementById('playBtn').addEventListener('click', ()=>{ if(currentIndex<0){ rebuildQueue(); if(queue.length){ playIndex(0); } return; } if(audio.paused) audio.play(); else audio.pause(); });

/* -------------------- Mini tests (run with ?test=1) -------------------- */
(function runTests(){ const p = new URLSearchParams(location.search); if(p.get('test') !== '1') return; console.log('%c[Test] Running quick checks','color:#1db954'); try{ localStorage.setItem(STORAGE_KEY, JSON.stringify([])); sessionFiles = []; render(''); console.log('[T1] empty ok'); const bogus = [null,1,'x',{}, {type:'audio'}, {type:'embed', src:'https://open.spotify.com/track/7ouMYWpwJ422jRcDASZB7P'}]; localStorage.setItem(STORAGE_KEY, JSON.stringify(bogus)); render(''); console.log('[T2] sanitize ok'); const blob = new Blob(['123'],{type:'audio/mpeg'}); const u = URL.createObjectURL(blob); sessionFiles.push({type:'audio', src:u, title:'test.mp3', mime:'audio/mpeg'}); render(''); console.log('[T3] session file ok'); const node = makeCard(undefined,0); console.assert(node && node.nodeType===1,'makeCard should return a node'); console.log('[T4] makeCard guard ok'); }catch(e){ console.error('[Tests] failed',e);} })();

// initial render
render();
</script>
</body>
</html>
